(function(m){function u(d,f){return parseInt(d.getAttribute(f)||1)}function I(d,f,B){function C(g,a){g=g.cloneNode(a);g.removeAttribute("id");return g}function A(){var g=0;e=[];h(["thead","tbody","tfoot"],function(a){var n=f.select("> "+a+" tr",d);h(n,function(n,j){j+=g;h(f.select("> td, > th",n),function(g,n){var c,b,t,f;if(e[j])for(;e[j][n];)n++;t=u(g,"rowspan");f=u(g,"colspan");for(b=j;b<j+t;b++){e[b]||(e[b]=[]);for(c=n;c<n+f;c++)e[b][c]={part:a,real:b==j&&c==n,elm:g,rowspan:t,colspan:f}}})});
g+=n.length})}function w(g,a){var n;if(n=e[a])return n[g]}function r(g,a,e){g&&(e=parseInt(e),1===e?g.removeAttribute(a,1):g.setAttribute(a,e,1))}function a(g){return g&&(f.hasClass(g.elm,"mceSelected")||g==s)}function l(){var g=[];h(d.rows,function(a){h(a.cells,function(e){if(f.hasClass(e,"mceSelected")||e==s.elm)return g.push(a),!1})});return g}function D(a){var e;m.walk(a,function(c){var b;if(3==c.nodeType)return h(f.getParents(c.parentNode,null,a).reverse(),function(a){a=C(a,!1);e?b&&b.appendChild(a):
e=b=a;b=a}),b&&(b.innerHTML=m.isIE?"&nbsp;":'<br data-mce-bogus="1" />'),!1},"childNodes");a=C(a,!1);r(a,"rowSpan",1);r(a,"colSpan",1);e?a.appendChild(e):m.isIE||(a.innerHTML='<br data-mce-bogus="1" />');return a}function v(){var a=f.createRng();h(f.select("tr",d),function(a){0==a.cells.length&&f.remove(a)});if(0==f.select("tr",d).length)a.setStartAfter(d),a.setEndAfter(d),B.setRng(a),f.remove(d);else if(h(f.select("thead,tbody,tfoot",d),function(a){0==a.rows.length&&f.remove(a)}),A(),row=e[Math.min(e.length-
1,b.y)])B.select(row[Math.min(row.length-1,b.x)].elm,!0),B.collapse(!0)}function z(a,b,c,t){var j,k,p,F,d;j=e[b][a].elm.parentNode;for(p=1;p<=c;p++)if(j=f.getNext(j,"tr")){for(k=a;0<=k;k--)if(d=e[b+p][k].elm,d.parentNode==j){for(F=1;F<=t;F++)f.insertAfter(D(d),d);break}if(-1==k)for(F=1;F<=t;F++)j.insertBefore(D(j.cells[0]),j.cells[0])}}function o(){h(e,function(e,b){h(e,function(e,g){var j,c,p;if(a(e)&&(e=e.elm,j=u(e,"colspan"),c=u(e,"rowspan"),1<j||1<c)){r(e,"rowSpan",1);r(e,"colSpan",1);for(p=0;p<
j-1;p++)f.insertAfter(D(e),e);z(g,b,c-1,j)}})})}function q(a){var c;h(e,function(e,b){h(e,function(e,k){if(e.elm==a)return c={x:k,y:b},!1});return!c});return c}var e,b,c,s;A();if(s=f.getParent(B.getStart(),"th,td")){b=q(s);var G,H;G=H=0;h(e,function(g,c){h(g,function(g,b){var j,k;a(g)&&(g=e[c][b],b>G&&(G=b),c>H&&(H=c),g.real&&(j=g.colspan-1,k=g.rowspan-1,j&&b+j>G&&(G=b+j),k&&c+k>H&&(H=c+k)))})});c={x:G,y:H};s=w(b.x,b.y)}m.extend(this,{deleteTable:function(){var a=f.createRng();a.setStartAfter(d);
a.setEndAfter(d);B.setRng(a);f.remove(d)},split:o,merge:function(g,E,n){var t,j,k,p,d,l;g?(pos=q(g),t=pos.x,g=pos.y,E=t+(E-1),n=g+(n-1)):(b=c=null,h(e,function(e,g){h(e,function(e,j){a(e)&&(b||(b={x:j,y:g}),c={x:j,y:g})})}),t=b.x,g=b.y,E=c.x,n=c.y);p=w(t,g);j=w(E,n);if(p&&j&&p.part==j.part){o();A();p=w(t,g).elm;r(p,"colSpan",E-t+1);r(p,"rowSpan",n-g+1);for(k=g;k<=n;k++)for(j=t;j<=E;j++)e[k]&&e[k][j]&&(g=e[k][j].elm,g!=p&&(d=m.grep(g.childNodes),h(d,function(a){p.appendChild(a)}),d.length&&(d=m.grep(p.childNodes),
l=0,h(d,function(a){a.nodeName=="BR"&&(f.getAttrib(a,"data-mce-bogus")&&l++<d.length-1)&&p.removeChild(a)})),f.remove(g)));v()}},insertRow:function(g){var c,b,d,j,k,p,l,s;h(e,function(e,b){h(e,function(e){if(a(e)&&(e=e.elm,k=e.parentNode,p=C(k,!1),c=b,g))return!1});if(g)return!c});for(j=0;j<e[0].length;j++)if(e[c][j]&&(b=e[c][j].elm,b!=d)){if(g){if(0<c&&e[c-1][j]&&(l=e[c-1][j].elm,s=u(l,"rowSpan"),1<s)){r(l,"rowSpan",s+1);continue}}else if(s=u(b,"rowspan"),1<s){r(b,"rowSpan",s+1);continue}d=D(b);
r(d,"colSpan",b.colSpan);p.appendChild(d);d=b}p.hasChildNodes()&&(g?k.parentNode.insertBefore(p,k):f.insertAfter(p,k))},insertCol:function(c){var b,d;h(e,function(e){h(e,function(e,k){if(a(e)&&(b=k,c))return!1});if(c)return!b});h(e,function(a,e){var k,p,l;a[b]&&(k=a[b].elm,k!=d&&(l=u(k,"colspan"),p=u(k,"rowspan"),1==l?(c?k.parentNode.insertBefore(D(k),k):f.insertAfter(D(k),k),z(b,e,p-1,l)):r(k,"colSpan",k.colSpan+1),d=k))})},deleteCols:function(){var b=[];h(e,function(c){h(c,function(c,d){a(c)&&-1===
m.inArray(b,d)&&(h(e,function(a){var a=a[d].elm,e;e=u(a,"colSpan");1<e?r(a,"colSpan",e-1):f.remove(a)}),b.push(d))})});v()},deleteRows:function(){var a;a=l();h(a.reverse(),function(a){var b,c;f.getNext(a,"tr");h(a.cells,function(a){var e=u(a,"rowSpan");1<e&&(r(a,"rowSpan",e-1),b=q(a),z(b.x,b.y,1,1))});b=q(a.cells[0]);h(e[b.y],function(a){var e,a=a.elm;a!=c&&(e=u(a,"rowSpan"),1>=e?f.remove(a):r(a,"rowSpan",e-1),c=a)})});v()},cutRows:function(){var a=l();f.remove(a);v();return a},copyRows:function(){var a=
l();h(a,function(e,b){a[b]=C(e,!0)});return a},pasteRows:function(a,b){var c=l(),d=c[b?0:c.length-1],j=d.cells.length;h(e,function(a){var e;j=0;h(a,function(a){a.real&&(j+=a.colspan);a.elm.parentNode==d&&(e=1)});if(e)return!1});b||a.reverse();h(a,function(a){var e=a.cells.length,c;for(i=0;i<e;i++)c=a.cells[i],r(c,"colSpan",1),r(c,"rowSpan",1);for(i=e;i<j;i++)a.appendChild(D(a.cells[e-1]));for(i=j;i<e;i++)f.remove(a.cells[i]);b?d.parentNode.insertBefore(a,d):f.insertAfter(a,d)});f.removeClass(f.select("td.mceSelected,th.mceSelected"),
"mceSelected")},getPos:q,setStartCell:function(a){b=q(a)},setEndCell:function(a){var d,l,s,j,k,p,h;c=q(a);if(b&&c){d=Math.min(b.x,c.x);l=Math.min(b.y,c.y);s=Math.max(b.x,c.x);j=Math.max(b.y,c.y);k=s;p=j;for(y=l;y<=p;y++)a=e[y][d],a.real||d-(a.colspan-1)<d&&(d-=a.colspan-1);for(x=d;x<=k;x++)a=e[l][x],a.real||l-(a.rowspan-1)<l&&(l-=a.rowspan-1);for(y=l;y<=j;y++)for(x=d;x<=s;x++)a=e[y][x],a.real&&(h=a.colspan-1,a=a.rowspan-1,h&&x+h>k&&(k=x+h),a&&y+a>p&&(p=y+a));f.removeClass(f.select("td.mceSelected,th.mceSelected"),
"mceSelected");for(y=l;y<=p;y++)for(x=d;x<=k;x++)e[y][x]&&f.addClass(e[y][x].elm,"mceSelected")}}})}var h=m.each;m.create("tinymce.plugins.TablePlugin",{init:function(d,f){function B(a){var l=d.selection;if(a=d.dom.getParent(a||l.getNode(),"table"))return new I(a,d.dom,l)}function C(){d.getBody().style.webkitUserSelect="";r&&(d.dom.removeClass(d.dom.select("td.mceSelected,th.mceSelected"),"mceSelected"),r=!1)}var A,w,r=!0;h([["table","table.desc","mceInsertTable",!0],["delete_table","table.del","mceTableDelete"],
["delete_col","table.delete_col_desc","mceTableDeleteCol"],["delete_row","table.delete_row_desc","mceTableDeleteRow"],["col_after","table.col_after_desc","mceTableInsertColAfter"],["col_before","table.col_before_desc","mceTableInsertColBefore"],["row_after","table.row_after_desc","mceTableInsertRowAfter"],["row_before","table.row_before_desc","mceTableInsertRowBefore"],["row_props","table.row_desc","mceTableRowProps",!0],["cell_props","table.cell_desc","mceTableCellProps",!0],["split_cells","table.split_cells_desc",
"mceTableSplitCells",!0],["merge_cells","table.merge_cells_desc","mceTableMergeCells",!0]],function(a){d.addButton(a[0],{title:a[1],cmd:a[2],ui:a[3]})});m.isIE||d.onClick.add(function(a,d){d=d.target;"TABLE"===d.nodeName&&(a.selection.select(d),a.nodeChanged())});d.onPreProcess.add(function(a,d){var f,h,m,o=a.dom,q;f=o.select("table",d.node);for(h=f.length;h--;){m=f[h];o.setAttrib(m,"data-mce-style","");if(q=o.getAttrib(m,"width"))o.setStyle(m,"width",q),o.setAttrib(m,"width","");if(q=o.getAttrib(m,
"height"))o.setStyle(m,"height",q),o.setAttrib(m,"height","")}});d.onNodeChange.add(function(a,d,f){f=a.selection.getStart();a=a.dom.getParent(f,"td,th,caption");d.setActive("table","TABLE"===f.nodeName||!!a);a&&"CAPTION"===a.nodeName&&(a=0);d.setDisabled("delete_table",!a);d.setDisabled("delete_col",!a);d.setDisabled("delete_table",!a);d.setDisabled("delete_row",!a);d.setDisabled("col_after",!a);d.setDisabled("col_before",!a);d.setDisabled("row_after",!a);d.setDisabled("row_before",!a);d.setDisabled("row_props",
!a);d.setDisabled("cell_props",!a);d.setDisabled("split_cells",!a);d.setDisabled("merge_cells",!a)});d.onInit.add(function(a){function d(a){if(m.isWebKit){var b=a.selection.getRng(),c=a.selection.getNode(),f=a.dom.getParent(b.startContainer,"TD,TH"),h=f,l=a.dom.getParent(b.startContainer,"TABLE"),g;l&&(g=l.parentNode);l=3==b.startContainer.nodeType&&0==b.startOffset&&0==b.endOffset&&h&&("TR"==c.nodeName||c==g);h=("TD"==c.nodeName||"TH"==c.nodeName)&&!h;if(l||h){f||(f=c);for(c=f.lastChild;c.lastChild;)c=
c.lastChild;b.setEnd(c,c.nodeValue.length);a.selection.setRng(b)}}}function f(){var e;for(e=a.getBody().lastChild;e&&3==e.nodeType&&!e.nodeValue.length;e=e.previousSibling);e&&"TABLE"==e.nodeName&&(a.settings.forced_root_block?a.dom.add(a.getBody(),a.settings.forced_root_block,null,m.isIE?"&nbsp;":'<br data-mce-bogus="1" />'):a.dom.add(a.getBody(),"br",{"data-mce-bogus":"1"}))}var v,z,o=a.dom,q;A=a.windowManager;a.onMouseDown.add(function(a,b){2!=b.button&&(C(),z=o.getParent(b.target,"td,th"),v=o.getParent(z,
"table"))});o.bind(a.getDoc(),"mouseover",function(e){var b,c=e.target;if(z&&(q||c!=z)&&("TD"==c.nodeName||"TH"==c.nodeName)){b=o.getParent(c,"table");b==v&&(q||(q=B(b),q.setStartCell(z),a.getBody().style.webkitUserSelect="none"),q.setEndCell(c),r=!0);b=a.selection.getSel();try{b.removeAllRanges?b.removeAllRanges():b.empty()}catch(d){}e.preventDefault()}});a.onMouseUp.add(function(a){var b,c=a.selection,d;c.getSel();var f,h;if(z){q&&(a.getBody().style.webkitUserSelect="");var g=function(a,e){var c=
new m.dom.TreeWalker(a,a);do{if(a.nodeType==3&&m.trim(a.nodeValue).length!=0){e?b.setStart(a,0):b.setEnd(a,a.nodeValue.length);break}if(a.nodeName=="BR"){e?b.setStartBefore(a):b.setEndBefore(a);break}}while(a=e?c.next():c.prev())};d=o.select("td.mceSelected,th.mceSelected");if(0<d.length){b=o.createRng();f=d[0];b.setStartBefore(f);b.setEndAfter(f);g(f,1);d=new m.dom.TreeWalker(f,o.getParent(d[0],"table"));do if("TD"==f.nodeName||"TH"==f.nodeName){if(!o.hasClass(f,"mceSelected"))break;h=f}while(f=
d.next());g(h);c.setRng(b)}a.nodeChanged();z=q=v=null}});a.onKeyUp.add(function(){C()});a.onKeyDown.add(function(a){d(a)});a.onMouseDown.add(function(a,b){2!=b.button&&d(a)});a.plugins.table.fixTableCellSelection=d;a&&a.plugins.contextmenu&&a.plugins.contextmenu.onContextMenu.add(function(e,b,c){e=a.selection.getNode()||a.getBody();a.dom.getParent(c,"td")||a.dom.getParent(c,"th")||a.dom.select("td.mceSelected,th.mceSelected").length?(b.removeAll(),"A"==e.nodeName&&!a.dom.getAttrib(e,"name")&&(b.add({title:"advanced.link_desc",
icon:"link",cmd:a.plugins.advlink?"mceAdvLink":"mceLink",ui:!0}),b.add({title:"advanced.unlink_desc",icon:"unlink",cmd:"UnLink"}),b.addSeparator()),"IMG"==e.nodeName&&-1==e.className.indexOf("mceItem")&&(b.add({title:"advanced.image_desc",icon:"image",cmd:a.plugins.advimage?"mceAdvImage":"mceImage",ui:!0}),b.addSeparator()),b.add({title:"table.desc",icon:"table",cmd:"mceInsertTable",value:{action:"insert"}}),b.add({title:"table.props_desc",icon:"table_props",cmd:"mceInsertTable"}),b.add({title:"table.del",
icon:"delete_table",cmd:"mceTableDelete"}),b.addSeparator(),c=b.addMenu({title:"table.cell"}),c.add({title:"table.cell_desc",icon:"cell_props",cmd:"mceTableCellProps"}),c.add({title:"table.split_cells_desc",icon:"split_cells",cmd:"mceTableSplitCells"}),c.add({title:"table.merge_cells_desc",icon:"merge_cells",cmd:"mceTableMergeCells"}),c=b.addMenu({title:"table.row"}),c.add({title:"table.row_desc",icon:"row_props",cmd:"mceTableRowProps"}),c.add({title:"table.row_before_desc",icon:"row_before",cmd:"mceTableInsertRowBefore"}),
c.add({title:"table.row_after_desc",icon:"row_after",cmd:"mceTableInsertRowAfter"}),c.add({title:"table.delete_row_desc",icon:"delete_row",cmd:"mceTableDeleteRow"}),c.addSeparator(),c.add({title:"table.cut_row_desc",icon:"cut",cmd:"mceTableCutRow"}),c.add({title:"table.copy_row_desc",icon:"copy",cmd:"mceTableCopyRow"}),c.add({title:"table.paste_row_before_desc",icon:"paste",cmd:"mceTablePasteRowBefore"}).setDisabled(!w),c.add({title:"table.paste_row_after_desc",icon:"paste",cmd:"mceTablePasteRowAfter"}).setDisabled(!w),
c=b.addMenu({title:"table.col"}),c.add({title:"table.col_before_desc",icon:"col_before",cmd:"mceTableInsertColBefore"}),c.add({title:"table.col_after_desc",icon:"col_after",cmd:"mceTableInsertColAfter"}),c.add({title:"table.delete_col_desc",icon:"delete_col",cmd:"mceTableDeleteCol"})):b.add({title:"table.desc",icon:"table",cmd:"mceInsertTable"})});m.isWebKit&&a.onKeyDown.add(function(a,b){function c(b,g,h){var l=b?"previousSibling":"nextSibling",o=a.dom.getParent(g,"tr"),q=o[l];if(q)return f(a,g,
q,b),m.dom.Event.cancel(h),!0;var q=a.dom.getParent(o,"table"),n=o.parentNode,r=n.nodeName.toLowerCase();if("tbody"===r||r===(b?"tfoot":"thead")){var r=a.dom.select(">tbody",q),v=r.indexOf(n);b&&0===v||!b&&v===r.length-1?(n=a.dom.select(">"+(b?"thead":"tfoot"),q),n=0!==n.length?n[0]:null):-1===v?(n="thead"===n.tagName.toLowerCase()?0:r.length-1,n=r[n]):n=r[v+(b?-1:1)];if(null!==n)return(o=d(n,b))&&f(a,g,o,b),m.dom.Event.cancel(h),!0}(g=q[l])?(a.selection.setCursorLocation(g,0),h=!0):(g=a.dom.getParent(q,
"td,th"))?h=c(b,g,h):(b=d(o,!b),a.selection.setCursorLocation(b,0),h=m.dom.Event.cancel(h));return h}function d(b,c){var f=b&&b[c?"lastChild":"firstChild"];return f&&"BR"===f.nodeName?a.dom.getParent(f,"td,th"):f}function f(b,c,g,l){for(var n=0,b=b.dom.getParent(c,"td,th");b.previousSibling;)b=b.previousSibling,n+=u(b,"colspan");var o=n,m=0,q=0;h(g.children,function(a,b){m+=u(a,"colspan");q=b;if(m>o)return!1});g=g.childNodes[q];l=d(g,l);a.selection.setCursorLocation(l||g,0)}var l=m.VK,g=b.keyCode,
o;if(o=g==l.UP||g==l.DOWN){o=a;var n=o.selection.getNode();o=null!==o.dom.getParent(n,"tr")}if(o){var q=a.selection.getNode();setTimeout(function(){var d=a.selection.getNode(),d=a.dom.getParent(d,"td,th"),f=a.dom.getParent(q,"td,th");d&&(d!==f&&a.dom.getParent(d,"TABLE")===a.dom.getParent(f,"TABLE"))&&c(!b.shiftKey&&g===l.UP,q,b)},0)}});m.isGecko&&a.onKeyDown.add(function(a,b){var c,d,f=a.dom;if(37==b.keyCode||38==b.keyCode)if(c=a.selection.getRng(),(d=f.getParent(c.startContainer,"table"))&&a.getBody().firstChild==
d){var h=c,g=d.ownerDocument;c=g.createRange();c.setStartBefore(d);c.setEnd(h.endContainer,h.endOffset);h=g.createElement("body");h.appendChild(c.cloneContents());0==h.innerHTML.replace(/<(br|img|object|embed|input|textarea)[^>]*>/gi,"-").replace(/<[^>]+>/g,"").length&&(c=f.createRng(),c.setStartBefore(d),c.setEndBefore(d),a.selection.setRng(c),b.preventDefault())}});a.onKeyUp.add(f);a.onSetContent.add(f);a.onVisualAid.add(f);a.onPreProcess.add(function(a,b){var c=b.node.lastChild;c&&(("BR"==c.nodeName||
1==c.childNodes.length&&("BR"==c.firstChild.nodeName||"\u00a0"==c.firstChild.nodeValue))&&c.previousSibling&&"TABLE"==c.previousSibling.nodeName)&&a.dom.remove(c)});m.isGecko&&a.onKeyDown.add(function(a,b){if(b.keyCode===m.VK.ENTER&&b.shiftKey){var c=a.selection.getRng().startContainer;if(o.getParent(c,"td,th")){var d=a.getDoc().createTextNode("\ufeff");o.insertAfter(d,c)}}});f();a.startContent=a.getContent({format:"raw"})});h({mceTableSplitCells:function(a){a.split()},mceTableMergeCells:function(a){var h,
m,r;if(r=d.dom.getParent(d.selection.getNode(),"th,td"))h=r.rowSpan,m=r.colSpan;d.dom.select("td.mceSelected,th.mceSelected").length?a.merge():A.open({url:f+"/merge_cells.htm",width:240+parseInt(d.getLang("table.merge_cells_delta_width",0)),height:110+parseInt(d.getLang("table.merge_cells_delta_height",0)),inline:1},{rows:h,cols:m,onaction:function(d){a.merge(r,d.cols,d.rows)},plugin_url:f})},mceTableInsertRowBefore:function(a){a.insertRow(!0)},mceTableInsertRowAfter:function(a){a.insertRow()},mceTableInsertColBefore:function(a){a.insertCol(!0)},
mceTableInsertColAfter:function(a){a.insertCol()},mceTableDeleteCol:function(a){a.deleteCols()},mceTableDeleteRow:function(a){a.deleteRows()},mceTableCutRow:function(a){w=a.cutRows()},mceTableCopyRow:function(a){w=a.copyRows()},mceTablePasteRowBefore:function(a){a.pasteRows(w,!0)},mceTablePasteRowAfter:function(a){a.pasteRows(w)},mceTableDelete:function(a){a.deleteTable()}},function(a,f){d.addCommand(f,function(){var f=B();f&&(a(f),d.execCommand("mceRepaint"),C())})});h({mceInsertTable:function(a){A.open({url:f+
"/table.htm",width:400+parseInt(d.getLang("table.table_delta_width",0)),height:385+parseInt(d.getLang("table.table_delta_height",0)),inline:1},{plugin_url:f,action:a?a.action:0})},mceTableRowProps:function(){A.open({url:f+"/row.htm",width:400+parseInt(d.getLang("table.rowprops_delta_width",0)),height:295+parseInt(d.getLang("table.rowprops_delta_height",0)),inline:1},{plugin_url:f})},mceTableCellProps:function(){A.open({url:f+"/cell.htm",width:400+parseInt(d.getLang("table.cellprops_delta_width",0)),
height:295+parseInt(d.getLang("table.cellprops_delta_height",0)),inline:1},{plugin_url:f})}},function(a,f){d.addCommand(f,function(d,f){a(f)})})}});m.PluginManager.add("table",m.plugins.TablePlugin)})(tinymce);